% Extract raw data from "Ensaio com Carga 07_2024" sheet
throttle = [0.43, 0.395, 0.36, 0.325, 0.288, 0.253, 0.385, 0.355, 0.327, 0.299, 0.271, 0.436, 0.39, 0.367, 0.345, 0.322, 0.3, 0.279, 0.257, 0.381, 0.348, 0.321, 0.303, 0.286, 0.272, 0.256, 0.241, 0.226, 0.272, 0.253, 0.2197, 0.22];
rpm = [1001.5, 999.58, 1000.1, 999.27, 999.28, 998.74, 798.98, 801.27, 799.56, 800.17, 800.63, 600.32, 599.45, 600.24, 600.5, 600.01, 600.56, 600.14, 600.99, 400.8, 397.68, 393.32, 400.96, 401.22, 400.95, 401.03, 400.85, 400.95, 200.95, 201.26, 200.0, 200.0];
v_dc = [95.79, 98.69, 101.22, 104.24, 107.3, 109.91, 99.25, 101.55, 103.84, 106.12, 107.51, 93.71, 97.72, 99.77, 101.7, 103.83, 105.75, 107.65, 109.48, 95.9, 90.66, 93.88, 95.66, 97.08, 95.11, 95.21, 96.47, 94.21, 97.82, 99.01, 100.11, 100.1];
i_dc = [118.96, 96.38, 76.59, 57.08, 38.55, 21.81, 94.25, 76.79, 60.27, 45.23, 31.22, 131.58, 99.31, 84.44, 70.79, 57.21, 45.83, 34.67, 23.75, 105.65, 86.55, 64.56, 52.97, 43.29, 35.73, 26.82, 18.31, 10.31, 27.43, 19.17, 5.063, 5.063];
u1 = [71.71, 72.37, 73.01, 73.79, 74.58, 75.21, 65.75, 66.15, 66.42, 66.83, 67.0, 57.917, 58.234, 58.324, 58.44, 58.559, 58.714, 58.864, 59.013, 50.403, 47.633, 47.222, 47.408, 47.371, 46.353, 45.848, 45.689, 44.624, 35.349, 34.649, 32.578, 32.578];
u2 = [71.88, 72.51, 73.12, 73.88, 74.69, 75.28, 65.87, 66.26, 66.51, 66.86, 67.06, 58.091, 58.358, 58.419, 58.496, 58.578, 58.748, 58.858, 59.022, 50.716, 47.837, 47.352, 47.511, 47.438, 46.426, 45.903, 45.707, 44.631, 35.335, 34.603, 32.534, 32.534];
u3 = [71.63, 72.27, 72.92, 73.66, 74.48, 75.13, 65.68, 66.06, 66.32, 66.69, 66.81, 57.837, 58.156, 58.247, 58.31, 58.441, 58.567, 58.664, 58.77, 50.381, 47.553, 47.13, 47.307, 47.241, 46.225, 45.714, 45.522, 44.48, 35.192, 34.407, 32.462, 32.462];
i1 = [107.97, 90.72, 74.25, 57.625, 40.491, 24.596, 108.29, 90.61, 73.36, 56.891, 40.427, 176.56, 140.88, 123.47, 106.77, 88.98, 73.08, 56.664, 40.425, 194.13, 157.85, 126.73, 106.43, 89.1, 73.23, 55.81, 39.479, 22.33, 96.41, 70.64, 20.641, 20.641];
i2 = [108.47, 91.23, 74.82, 57.751, 40.388, 24.115, 109.0, 91.42, 74.01, 57.296, 40.021, 177.19, 141.47, 124.2, 106.85, 89.22, 72.94, 56.688, 39.478, 190.9, 154.71, 123.72, 103.59, 86.35, 70.82, 53.63, 37.404, 20.83, 97.62, 71.23, 19.336, 19.336];
i3 = [108.59, 90.81, 73.91, 56.751, 39.566, 23.164, 108.66, 90.65, 73.14, 55.928, 39.048, 179.54, 142.51, 124.47, 106.98, 88.58, 72.27, 55.587, 38.703, 196.06, 158.27, 126.11, 105.36, 87.82, 71.99, 54.43, 37.933, 20.959, 97.09, 70.36, 19.424, 19.424];
peso = [11.97, 10.01, 8.08, 6.1, 4.04, 2.04, 12.11, 10.07, 8.04, 6.08, 4.11, 20.16, 16.08, 14.05, 12.05, 9.97, 8.03, 6.09, 4.05, 22.17, 18.01, 14.2, 11.97, 10.0, 8.09, 6.02, 4.05, 2.01, 11.04, 7.98, 1.99, 2.03];

% Calculate Torque (Nm)
lever_arm = 0.8; % meters
torque = peso * lever_arm * 9.807;

% Calculate V_RMS (average of U1, U2, U3)
u_rms = mean([u1; u2; u3], 1);

% Calculate I_RMS (average of I1, I2, I3)
i_rms = mean([i1; i2; i3], 1);

% Define grid points for Throttle and RPM
throttle_grid = unique(throttle);
rpm_grid = unique(rpm);

% Interpolate data onto a grid using griddata
[THROTTLE, RPM] = meshgrid(throttle_grid, rpm_grid);
V_DC_load = griddata(throttle, rpm, v_dc, THROTTLE, RPM, 'linear');
I_DC_load = griddata(throttle, rpm, i_dc, THROTTLE, RPM, 'linear');
V_RMS = griddata(throttle, rpm, u_rms, THROTTLE, RPM, 'linear');
I_RMS = griddata(throttle, rpm, i_rms, THROTTLE, RPM, 'linear');
TORQUE = griddata(throttle, rpm, torque, THROTTLE, RPM, 'linear');

% Compile into a MATLAB table
motorData = table(throttle', rpm', v_dc', i_dc', u_rms', i_rms', torque', ...
    'VariableNames', {'Throttle', 'RPM', 'V_DC', 'I_DC', 'V_RMS', 'I_RMS', 'Torque'});

% Save for Simulink
save('motorData.mat', 'motorData');